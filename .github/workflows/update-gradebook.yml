name: Gradebook Update

on:
  schedule:
    - cron: "0 11 * * FRI"
  workflow_dispatch: {}

permissions:
  contents: write
  actions: read

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Update gradebook from recent Autograde runs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          WORKFLOW_FILE: autograde.yml
          ARTIFACT_NAME: autograder-results
        run: |
          python3 - <<'PY'
          import csv, io, json, os, re, sys, zipfile
          from pathlib import Path
          from urllib.request import Request, urlopen

          REPO = os.environ["REPO"]
          WORKFLOW_FILE = os.environ["WORKFLOW_FILE"]
          ARTIFACT_NAME = os.environ["ARTIFACT_NAME"]
          TOKEN = os.environ["GH_TOKEN"]

          def api_get(url: str):
            req = Request(url, headers={
              "Authorization": f"Bearer {TOKEN}",
              "Accept": "application/vnd.github+json",
              "User-Agent": "gradebook-updater"
            })
            with urlopen(req) as r:
              return json.load(r)

          def api_download_zip(url: str) -> bytes:
            req = Request(url, headers={
              "Authorization": f"Bearer {TOKEN}",
              "Accept": "application/vnd.github+json",
              "User-Agent": "gradebook-updater"
            })
            with urlopen(req) as r:
              return r.read()

          gradebook = Path("autograder/gradebook.csv")
          gradebook.parent.mkdir(parents=True, exist_ok=True)

          # Collect already recorded run_ids to avoid duplicates
          seen_run_ids = set()
          if gradebook.exists():
            with gradebook.open("r", encoding="utf-8", newline="") as f:
              reader = csv.DictReader(f)
              for row in reader:
                rid = row.get("run_id")
                if rid:
                  seen_run_ids.add(rid)

          # List recent workflow runs (last 100). Increase if needed.
          runs_url = f"https://api.github.com/repos/{REPO}/actions/workflows/{WORKFLOW_FILE}/runs?per_page=100"
          runs = api_get(runs_url).get("workflow_runs", [])

          new_rows = []
          for r in runs:
            if r.get("conclusion") != "success":
              continue
            run_id = str(r["id"])
            if run_id in seen_run_ids:
              continue

            # Find artifacts for this run
            artifacts_url = f"https://api.github.com/repos/{REPO}/actions/runs/{run_id}/artifacts"
            artifacts = api_get(artifacts_url).get("artifacts", [])
            art = next((a for a in artifacts if a.get("name") == ARTIFACT_NAME), None)
            if not art:
              continue

            # Download artifact ZIP
            zip_bytes = api_download_zip(art["archive_download_url"])

            # Extract autograder_results.json from zip
            zf = zipfile.ZipFile(io.BytesIO(zip_bytes))
            json_name = next((n for n in zf.namelist() if n.endswith("autograder_results.json")), None)
            if not json_name:
              continue

            data = json.loads(zf.read(json_name).decode("utf-8"))
            student_dir = data.get("student_dir", "")
            student_id = student_dir.strip("/").split("/")[-1] if student_dir else "UNKNOWN"
            final_score = int(data.get("final_score", data.get("earned", 0)))
            maxp = int(data.get("max", 0))
            submitted_at = data.get("submitted_at", "")

            new_rows.append([student_id, final_score, maxp, submitted_at, run_id])

          if not new_rows:
            print("No new runs to append.")
            sys.exit(0)

          write_header = not gradebook.exists()
          with gradebook.open("a", encoding="utf-8", newline="") as f:
            w = csv.writer(f)
            if write_header:
              w.writerow(["student_id", "final_score", "max_points", "submitted_at", "run_id"])
            for row in new_rows:
              w.writerow(row)

          print(f"Appended {len(new_rows)} rows.")
          PY

      - name: Commit and push gradebook
        run: |
            git config user.name "github-actions"
            git config user.email "actions@github.com"
            if [-f autograder/gradebook.csv]; then
                git add autograder/gradebook.csv
                git commit -m "Weekly gradebook update" || exit 0
                git push
            else
                echo "No gradebook file created. Nothing to commit"
            fi